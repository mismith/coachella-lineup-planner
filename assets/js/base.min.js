angular.module("firebaseHelper",["firebase"]).service("$firebaseHelper",["$firebase","$firebaseAuth","$q",function(r,e,t){var o=this,a="",n={};return o.namespace=function(r){return void 0!==r&&(a=r),a},o.$auth=function(r){return r?angular.isString(r)?r=o.$ref(r):angular.isFunction(r.$ref)&&(r=r.$ref):r=o.$ref(),e(r)},o.$ref=function(){var r=Array.prototype.slice.call(arguments),e="Ref/"+r.join("/");if(n[e])return n[e];var t=new Firebase("https://"+a+".firebaseio.com/"+(r.join("/")||""));return n[e]=t,t},o.$inst=function(){if(1==arguments.length&&arguments[0]instanceof Firebase){var e=arguments[0],t="Inst"+e.path;if(n[t])return n[t];var a=r(e);return n[t]=a,a}var i=Array.prototype.slice.call(arguments),t="Inst/"+i.join("/");if(n[t])return n[t];var a=r(o.$ref.apply(this,i));return n[t]=a,a},o.$get=function(){var r=Array.prototype.slice.call(arguments),e="Object";r[r.length-1]===!0&&(e="Array",r.pop());var t=e+"/"+r.join("/");if(n[t])return n[t];var a=o.$inst.apply(this,r)["$as"+e]();return n[t]=a,a},o.$load=function(){return o.$get.apply(this,arguments).$loaded()},o.$child=function(){var r=Array.prototype.slice.call(arguments),e=r.shift();return angular.isFunction(e.$inst)&&(e=e.$inst()),angular.isFunction(e.$ref)&&(e=e.$ref()),angular.isFunction(e.child)?o.$inst(e.child(r.join("/"))):e},o.$populate=function(r,e,a){var n=[],i=o.$ref(r);return i.once("value",function(r){angular.isObject(r.val())||angular.isFunction(a)&&a()}),i.on("child_added",function(r){var i=o.$get(e,r.key());i.$loaded().then(function(){var r=[];angular.isFunction(a)&&r.push(a(i)),t.all(r).then(function(){n.push(i)})})}),i.on("child_removed",function(r){n.splice($rootScope.childById(n,r.key(),void 0,!0),1)}),n},o.$intersect=function(e,t,a,n){if(!Firebase.util)throw new Error("$firebaseHelper.$intersect requires Firebase.util external library. See: https://github.com/firebase/firebase-util");var i={ref:o.$ref(e)},u={ref:o.$ref(t)};return a&&(i.keyMap=a),n&&(u.keyMap=n),r(Firebase.util.intersection(i,u)).$asArray()},o}]),angular.module("coachella",["ui.router","ui.bootstrap","firebase","firebaseHelper"]).config(["$locationProvider","$urlRouterProvider","$stateProvider",function(r,e,t){e.when("","/"),t.state("year",{url:"/:year",templateUrl:"views/year.html"}).state("year.group",{url:"/:group"}).state("year:edit",{url:"/:year/edit",templateUrl:"views/edit.html",resolve:{authorization:["$rootScope","$q",function(r,e){var t=e.defer();return"facebook:120605287"==r.$me.uid?t.resolve():t.reject(),t.promise}]}})}]).controller("AppCtrl",["$rootScope","$state","$firebaseHelper",function(r,e,t){t.namespace("coachellalp"),r.$state=e;var o=function(){r.$me&&r.$me.$loaded&&r.$me.$loaded().then(function(r){e.params.year&&r.groups&&r.groups[e.params.year]&&e.go("year.group",{year:e.params.year,group:r.groups[e.params.year]})})};r.$me={},r.$auth=t.$auth(),r.$auth.$onAuth(function(e){e?(r.$me=t.$get("users/"+e.uid),r.$me.$inst().$update(e),o()):r.$me={}}),r.$on("$stateChangeSuccess",function(){e.params.year=e.params.year||2015,r.bands=t.$get("bands/"+e.params.year,!0),e.params.group?(r.group=t.$get("groups/"+e.params.year+"/"+e.params.group),r.users=t.$get("users")):(r.group=r.users=void 0,o())})}]).controller("GroupsCtrl",["$scope","$state","$q","$firebaseHelper",function(r,e,t,o){r.userInGroup=function(r,e){return e&&e.users?!!e.users[r]:!1},r.addUserToGroup=function(r,e,a){return t.all([o.$inst("users",r,"groups").$set(a,e),o.$inst("groups",a,e,"users").$set(r,r)])},r.removeUserFromGroup=function(r,e,a,n){return n||confirm("Are you sure you want to remove this user from this group?")?t.all([o.$inst("users",r,"groups").$remove(a),o.$inst("groups",a,e,"users").$remove(r)]):void 0},r.invite=function(){FB.ui({method:"apprequests",title:"Group Members",message:"Let's figure out which bands we all want to see this year."},function(t){if(t){if(t.error)console.error("Facebook Error: "+t.error);else if(t.to){var a=function(){r.group.$loaded().then(function(){t.to.push(r.$me.facebook.id),angular.forEach(t.to,function(t){var o="facebook:"+t;r.addUserToGroup(o,r.group.$id,e.params.year)})})};r.group?a():o.$get("groups",e.params.year,!0).$add().then(function(t){var n=t.key();r.group=o.$get("groups",e.params.year,n),a(),e.go("year.group",{group:n})})}}else console.error("Facebook Error: No Response")})}}]).controller("BandsCtrl",["$scope","$firebaseHelper",function(r,e){r.vote=function(t,o){var a=function(a){var n=e.$child(r.bands,t+"/votes/"+(a||r.$me.uid)+"/vote");n.$asObject().$loaded().then(function(r){r.$value==o?n.$remove():n.$set(o)})};r.$me.uid?a():r.$auth.$authWithOAuthPopup("facebook").then(function(r){a(r.uid)},function(r){console.error(r)})},r.filterDay=0,r.orderBy=void 0,r.orderByStr=void 0,r.orderByDir=!1,r.toggleOrder=function(e){if(e){var t={day:!1,name:!1,vote:!0,score:!0};if(r.orderByStr==e){if(r.orderByDir!==t[e])return r.toggleOrder();r.orderByDir=!r.orderByDir}else r.orderByDir=t[e]}switch(r.orderByStr=e,e){case"vote":e=function(e){var t=-2;return e.votes&&angular.forEach(e.votes,function(e,o){o==r.$me.uid&&(t=e.vote)}),t};break;case void 0:return r.orderBy=["day","$id"],r.orderByDir=!1,void 0;case"day":return r.orderBy=["day","name"],void 0}r.orderBy=e},r.toggleOrder()}]).controller("BandCtrl",["$scope",function(r){r.init=function(e){r.data=e},r.$watch("data.votes",function(e){var t=0;return angular.forEach(e,function(r){t+=r.vote}),r.data=r.data||{},r.data.score=t}),r.add=function(e){e&&e.name&&e.day&&r.bands.$add(e).then(function(){e.name="",r.added=!0})},r.remove=function(e,t){e&&e.$id&&(t||confirm("Are you sure you want to permanently delete this?"))&&r.bands.$remove(e)}}]).directive("ngAutofocus",function(){return{restrict:"A",link:function(r,e,t){r.$watch(function(){return r.$eval(t.ngAutofocus)},function(r){r&&e[0].focus()})}}});