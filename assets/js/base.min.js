angular.module("lineup-planner",["ui.router","ui.bootstrap","firebaseHelper"]).run(function(){FastClick.attach(document.body)}).config(["$urlRouterProvider","$stateProvider","$firebaseHelperProvider",function(e,r,t){e.when("","/"),e.when("/","/2015"),r.state("edit",{url:"/:event/edit",templateUrl:"views/edit.html"}).state("event",{url:"/:event",templateUrl:"views/event.html"}).state("group",{parent:"event",url:"/:group"}),t.namespace("coachellalp")}]).factory("Auth",["$firebaseHelper",function(e){return e.auth()}]).controller("AppCtrl",["$rootScope","$state","$firebaseHelper","Auth",function(e,r,t,o){e.$state=r;var n=function(){e.$me&&e.$me.$loaded&&e.$me.$loaded().then(function(t){r.params.event&&t.groups&&t.groups[r.params.event]&&!r.params.group&&"edit"!=r.current.name&&(e.$me.$defaultGroup=!1,angular.forEach(t.groups[r.params.event],function(r){e.$me.$defaultGroup||(e.$me.$defaultGroup=r)}),r.go("group",{event:r.params.event,group:e.$me.$defaultGroup}))})};e.$me={},e.$unauth=o.$unauth,o.$onAuth(function(r){r?(e.$me=t.object("users/"+r.uid),e.$me.$ref().update(r),n()):e.$me={}}),e.$authThen=function(r){e.$me.uid?angular.isFunction(r)&&r():o["$authWithOAuth"+(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?"Redirect":"Popup")]("facebook").then(function(e){angular.isFunction(r)&&r(e.uid)},function(e){console.error(e)})},e.events=t.array("events"),e.$on("$stateChangeSuccess",function(){e.event=t.object("events",r.params.event),e.bands=t.array("bands",r.params.event),e.event.$loaded().then(function(r){e.event.$days=["All Days"];for(var t=1;t<=r.days;t++)e.event.$days.push(t)}),r.params.group?(e.group=t.object("groups/"+r.params.event+"/"+r.params.group),e.users=t.join("groups/"+r.params.event+"/"+r.params.group+"/users","users")):(e.group=e.users=void 0,n())}),e.rubrics={"-1":"I would like to avoid this band.",0:"I don't really know this bandâ€¦",1:"I would see this band.",2:"I need to see this band!"}}]).controller("EventsCtrl",["$scope","$firebaseHelper","$state",function(e,r,t){e.newEvent=function(){var e=prompt('What\'s the event name and year \n(e.g. "Funpalooza 2015")?');if(e){var o=e.toLowerCase().replace(/[^a-z0-9-]/g,"-").replace(/-+/g,"-").replace(/^\-|\-$/g,"");r.ref("events/"+o).set({name:e},function(){t.go("edit",{event:o})})}}}]).controller("BandsCtrl",["$scope","$firebaseHelper",function(e,r){e.vote=function(t,o){e.$authThen(function(n){var a=r.object(e.bands,t+"/votes/"+(n||e.$me.uid)+"/vote"),u=a.$ref();a.$loaded().then(function(e){e.$value==o?u.remove():u.set(o)})})},e.filterDay=0,e.orderBy=void 0,e.orderByStr=void 0,e.orderByDir=!1,e.toggleOrder=function(r){if(r){var t={day:!1,name:!1,vote:!0,score:!0};if(e.orderByStr==r){if(e.orderByDir!==t[r])return e.toggleOrder();e.orderByDir=!e.orderByDir}else e.orderByDir=t[r]}switch(e.orderByStr=r,r){case"vote":r=function(r){var t=-2;return r.votes&&angular.forEach(r.votes,function(r,o){o==e.$me.uid&&(t=r.vote)}),t};break;case void 0:return e.orderBy=["day","$id"],e.orderByDir=!1,void 0;case"day":return e.orderBy=["day","name"],void 0}e.orderBy=r},e.toggleOrder()}]).controller("BandCtrl",["$scope",function(e){e.init=function(r){e.data=r},e.$watch("data.votes",function(r){var t=0;return angular.forEach(r,function(e){t+=e.vote}),e.data=e.data||{},e.data.score=t}),e.add=function(r){r&&r.name&&r.day?e.bands.$add(r).then(function(){r.name="",e.added=!0}):console.error("Missing required field.")},e.remove=function(r,t){r&&r.$id&&(t||confirm("Are you sure you want to permanently delete this?"))&&e.bands.$remove(r)}}]).controller("GroupsCtrl",["$scope","$state","$q","$http","$firebaseHelper",function(e,r,t,o,n){e.userInGroup=function(e,r){return r&&r.users?!!r.users[e]:!1},e.addUserToGroup=function(e,r,o){var a=t.defer(),u=t.defer();return n.ref("users",e,"groups",o,r).set(r,a.resolve),n.ref("groups",o,r,"users",e).set(e,u.resolve),t.all([a.promise,u.promise])},e.removeUserFromGroup=function(e,r,o,a){if(a||confirm("Are you sure you want to remove this user from this group?")){var u=t.defer(),s=t.defer();return n.ref("users",e,"groups",o,r).remove(function(e){e?u.reject():u.resolve()}),n.ref("groups",o,r,"users",e).remove(function(e){e?s.reject():s.resolve()}),t.all([u.promise,s.promise])}},e.invite=function(t){e.$authThen(function(){FB.ui({method:"apprequests",title:"Group Members",message:"Let's figure out which bands we all want to see this event."},function(a){if(a){if(a.error)console.error("Facebook Error: "+a.error);else if(a.to){var u=function(){t.$loaded().then(function(){angular.forEach(a.to,function(a){var u="facebook:"+a;o.get("https://graph.facebook.com/"+a).then(function(e){if(e&&e.data){var r=n.ref("users",u);r.child("uid").set(u),r.child("facebook").update(e.data),r.child("facebook/displayName").set(e.data.name)}}),e.addUserToGroup(u,t.$id,r.params.event)}),e.addUserToGroup(e.$me.uid,t.$id,r.params.event)})};t?u():n.array("groups",r.params.event).$add().then(function(e){var o=e.key();t=n.object("groups",r.params.event,o),u(),r.go("group",{group:o})})}}else console.error("Facebook Error: No Response")})})}}]).directive("ngAutofocus",function(){return{restrict:"A",link:function(e,r,t){e.$watch(function(){return e.$eval(t.ngAutofocus)},function(e){e&&r[0].focus()})}}}).filter("filterVotesByGroup",["$firebaseHelper",function(e){return function(r,t){var o=[];return r&&t&&t.users&&angular.forEach(r,function(r,n){t.users[n]&&(r.$user=e.object("users",n),o.push(r))}),o}}]);