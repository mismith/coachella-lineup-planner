angular.module("firebaseHelper",["firebase"]).service("$firebaseHelper",["$firebase","$firebaseAuth","$q",function(e,r,t){var a=this,o="",n={};return a.namespace=function(e){return void 0!==e&&(o=e),o},a.$auth=function(e){return e?angular.isString(e)?e=a.$ref(e):angular.isFunction(e.$ref)&&(e=e.$ref):e=a.$ref(),r(e)},a.$ref=function(){var e=Array.prototype.slice.call(arguments),r="Ref/"+e.join("/");if(n[r])return n[r];var t=new Firebase("https://"+o+".firebaseio.com/"+(e.join("/")||""));return n[r]=t,t},a.$inst=function(){if(1==arguments.length&&arguments[0]instanceof Firebase){var r=arguments[0],t="Inst"+r.path;if(n[t])return n[t];var o=e(r);return n[t]=o,o}var u=Array.prototype.slice.call(arguments),t="Inst/"+u.join("/");if(n[t])return n[t];var o=e(a.$ref.apply(this,u));return n[t]=o,o},a.$get=function(){var e=Array.prototype.slice.call(arguments),r="Object";e[e.length-1]===!0&&(r="Array",e.pop());var t=r+"/"+e.join("/");if(n[t])return n[t];var o=a.$inst.apply(this,e)["$as"+r]();return n[t]=o,o},a.$load=function(){return a.$get.apply(this,arguments).$loaded()},a.$child=function(){var e=Array.prototype.slice.call(arguments),r=e.shift();return angular.isFunction(r.$inst)&&(r=r.$inst()),angular.isFunction(r.$ref)&&(r=r.$ref()),angular.isFunction(r.child)?a.$inst(r.child(e.join("/"))):r},a.$populate=function(e,r,o){var n=[],u=a.$ref(e);return u.once("value",function(e){angular.isObject(e.val())||angular.isFunction(o)&&o()}),u.on("child_added",function(e){var u=a.$get(r,e.key());u.$loaded().then(function(){var e=[];angular.isFunction(o)&&e.push(o(u)),t.all(e).then(function(){n.push(u)})})}),u.on("child_removed",function(e){var r=-1,t=e.key();angular.forEach(n,function(e,a){r>=0||e.$id==t&&(r=a)}),r>=0&&n.splice(r,1)}),n},a.$intersect=function(r,t,o,n){if(!Firebase.util)throw new Error("$firebaseHelper.$intersect requires Firebase.util external library. See: https://github.com/firebase/firebase-util");var u={ref:a.$ref(r)},i={ref:a.$ref(t)};return o&&(u.keyMap=o),n&&(i.keyMap=n),e(Firebase.util.intersection(u,i)).$asArray()},a}]),angular.module("coachella",["ui.router","ui.bootstrap","firebase","firebaseHelper"]).run(function(){FastClick.attach(document.body)}).config(["$locationProvider","$urlRouterProvider","$stateProvider",function(e,r,t){r.when("","/"),r.when("/","/2015"),t.state("year",{url:"/:year",templateUrl:"views/year.html"}).state("year.group",{url:"/:group"}).state("year:edit",{url:"/:year/edit",templateUrl:"views/edit.html",resolve:{authorization:["$rootScope","$q",function(e,r){var t=r.defer();return"facebook:120605287"==e.$me.uid?t.resolve():t.reject(),t.promise}]}})}]).controller("AppCtrl",["$rootScope","$state","$firebaseHelper",function(e,r,t){t.namespace("coachellalp"),e.$state=r;var a=function(){e.$me&&e.$me.$loaded&&e.$me.$loaded().then(function(t){r.params.year&&t.groups&&t.groups[r.params.year]&&(e.$me.$defaultGroup=!1,angular.forEach(t.groups[r.params.year],function(r){e.$me.$defaultGroup||(e.$me.$defaultGroup=r)}),r.params.group||r.go("year.group",{year:r.params.year,group:e.$me.$defaultGroup}))})};e.$me={},e.$auth=t.$auth(),e.$auth.$onAuth(function(r){r?(e.$me=t.$get("users/"+r.uid),e.$me.$inst().$update(r),a()):e.$me={}}),e.$authThen=function(r){e.$me.uid?angular.isFunction(r)&&r():e.$auth["$authWithOAuth"+(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?"Redirect":"Popup")]("facebook").then(function(e){angular.isFunction(r)&&r(e.uid)},function(e){console.error(e)})},e.$on("$stateChangeSuccess",function(){e.bands=t.$get("bands/"+r.params.year,!0),r.params.group?(e.group=t.$get("groups/"+r.params.year+"/"+r.params.group),e.users=t.$populate("groups/"+r.params.year+"/"+r.params.group+"/users","users")):(e.group=e.users=void 0,a())}),e.rubrics={"-1":"I would like to avoid this band.",0:"I don't really know this band...",1:"I wouldn't mind seeing this band.",2:"I would love to see this band!"}}]).controller("BandsCtrl",["$scope","$firebaseHelper",function(e,r){e.vote=function(t,a){e.$authThen(function(o){var n=r.$child(e.bands,t+"/votes/"+(o||e.$me.uid)+"/vote");n.$asObject().$loaded().then(function(e){e.$value==a?n.$remove():n.$set(a)})})},e.filterDay=0,e.orderBy=void 0,e.orderByStr=void 0,e.orderByDir=!1,e.toggleOrder=function(r){if(r){var t={day:!1,name:!1,vote:!0,score:!0};if(e.orderByStr==r){if(e.orderByDir!==t[r])return e.toggleOrder();e.orderByDir=!e.orderByDir}else e.orderByDir=t[r]}switch(e.orderByStr=r,r){case"vote":r=function(r){var t=-2;return r.votes&&angular.forEach(r.votes,function(r,a){a==e.$me.uid&&(t=r.vote)}),t};break;case void 0:return e.orderBy=["day","$id"],e.orderByDir=!1,void 0;case"day":return e.orderBy=["day","name"],void 0}e.orderBy=r},e.toggleOrder()}]).controller("BandCtrl",["$scope",function(e){e.init=function(r){e.data=r},e.$watch("data.votes",function(r){var t=0;return angular.forEach(r,function(e){t+=e.vote}),e.data=e.data||{},e.data.score=t}),e.add=function(r){r&&r.name&&r.day&&e.bands.$add(r).then(function(){r.name="",e.added=!0})},e.remove=function(r,t){r&&r.$id&&(t||confirm("Are you sure you want to permanently delete this?"))&&e.bands.$remove(r)}}]).controller("GroupsCtrl",["$scope","$state","$q","$http","$firebaseHelper",function(e,r,t,a,o){e.userInGroup=function(e,r){return r&&r.users?!!r.users[e]:!1},e.addUserToGroup=function(e,r,a){return t.all([o.$inst("users",e,"groups",a).$set(r,r),o.$inst("groups",a,r,"users").$set(e,e)])},e.removeUserFromGroup=function(e,r,a,n){return n||confirm("Are you sure you want to remove this user from this group?")?t.all([o.$inst("users",e,"groups",a).$remove(r),o.$inst("groups",a,r,"users").$remove(e)]):void 0},e.invite=function(t){e.$authThen(function(){FB.ui({method:"apprequests",title:"Group Members",message:"Let's figure out which bands we all want to see this year."},function(n){if(n){if(n.error)console.error("Facebook Error: "+n.error);else if(n.to){var u=function(){t.$loaded().then(function(){angular.forEach(n.to,function(n){var u="facebook:"+n;a.get("https://graph.facebook.com/"+n).then(function(e){if(e&&e.data){var r=o.$inst("users",u);r.$set("uid",u),r.$update("facebook",e.data),r.$set("facebook/displayName",e.data.name)}}),e.addUserToGroup(u,t.$id,r.params.year)}),e.addUserToGroup(e.$me.uid,t.$id,r.params.year)})};t?u():o.$get("groups",r.params.year,!0).$add().then(function(e){var a=e.key();t=o.$get("groups",r.params.year,a),u(),r.go("year.group",{group:a})})}}else console.error("Facebook Error: No Response")})})}}]).directive("ngAutofocus",function(){return{restrict:"A",link:function(e,r,t){e.$watch(function(){return e.$eval(t.ngAutofocus)},function(e){e&&r[0].focus()})}}}).filter("filterVotesByGroup",["$firebaseHelper",function(e){return function(r,t){var a=[];return r&&t&&t.users&&angular.forEach(r,function(r,o){t.users[o]&&(r.$user=e.$get("users",o),a.push(r))}),a}}]);