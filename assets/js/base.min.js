angular.module("firebaseHelper",["firebase"]).service("$firebaseHelper",["$firebase","$firebaseAuth","$q",function(e,r,t){var o=this,n="",a={};return o.namespace=function(e){return void 0!==e&&(n=e),n},o.$auth=function(e){return e?angular.isString(e)?e=o.$ref(e):angular.isFunction(e.$ref)&&(e=e.$ref):e=o.$ref(),r(e)},o.$ref=function(){var e=Array.prototype.slice.call(arguments),r="Ref/"+e.join("/");if(a[r])return a[r];var t=new Firebase("https://"+n+".firebaseio.com/"+(e.join("/")||""));return a[r]=t,t},o.$inst=function(){if(1==arguments.length&&arguments[0]instanceof Firebase){var r=arguments[0],t="Inst"+r.path;if(a[t])return a[t];var n=e(r);return a[t]=n,n}var i=Array.prototype.slice.call(arguments),t="Inst/"+i.join("/");if(a[t])return a[t];var n=e(o.$ref.apply(this,i));return a[t]=n,n},o.$get=function(){var e=Array.prototype.slice.call(arguments),r="Object";e[e.length-1]===!0&&(r="Array",e.pop());var t=r+"/"+e.join("/");if(a[t])return a[t];var n=o.$inst.apply(this,e)["$as"+r]();return a[t]=n,n},o.$load=function(){return o.$get.apply(this,arguments).$loaded()},o.$child=function(){var e=Array.prototype.slice.call(arguments),r=e.shift();return angular.isFunction(r.$inst)&&(r=r.$inst()),angular.isFunction(r.$ref)&&(r=r.$ref()),angular.isFunction(r.child)?o.$inst(r.child(e.join("/"))):r},o.$populate=function(e,r,n){var a=[],i=o.$ref(e);return i.once("value",function(e){angular.isObject(e.val())||angular.isFunction(n)&&n()}),i.on("child_added",function(e){var i=o.$get(r,e.key());i.$loaded().then(function(){var e=[];angular.isFunction(n)&&e.push(n(i)),t.all(e).then(function(){a.push(i)})})}),i.on("child_removed",function(e){a.splice($rootScope.childById(a,e.key(),void 0,!0),1)}),a},o.$intersect=function(r,t,n,a){if(!Firebase.util)throw new Error("$firebaseHelper.$intersect requires Firebase.util external library. See: https://github.com/firebase/firebase-util");var i={ref:o.$ref(r)},u={ref:o.$ref(t)};return n&&(i.keyMap=n),a&&(u.keyMap=a),e(Firebase.util.intersection(i,u)).$asArray()},o}]),angular.module("coachella",["ui.router","ui.bootstrap","firebase","firebaseHelper"]).config(["$locationProvider","$urlRouterProvider","$stateProvider",function(e,r,t){r.when("","/"),r.when("/","/2015"),t.state("year",{url:"/:year",templateUrl:"views/year.html",resolve:{bands:["$rootScope","$stateParams","$firebaseHelper",function(e,r,t){return e.bands=t.$get("bands/"+r.year,!0),!0}]}}).state("year.group",{url:"/:group",resolve:{group:["$rootScope","$stateParams","$firebaseHelper",function(e,r,t){return e.group=t.$get("groups/"+r.year+"/"+r.group),e.users=t.$get("users"),!0}]}}).state("year:edit",{url:"/:year/edit",templateUrl:"views/edit.html",resolve:{authorization:["$rootScope","$q",function(e,r){var t=r.defer();return"facebook:120605287"==e.$me.uid?t.resolve():t.reject(),t.promise}]}})}]).controller("AppCtrl",["$scope","$rootScope","$state","$q","$firebaseHelper",function(e,r,t,o,n){n.namespace("coachellalp"),r.$state=t,r.$me={},r.$auth=n.$auth(),r.$auth.$onAuth(function(e){e&&(r.$me=n.$get("users/"+e.uid),r.$me.$inst().$update(e),r.$me.$loaded().then(function(e){!r.group&&e.groups&&e.groups[t.params.year]&&t.go("year.group",{year:t.params.year,group:e.groups[t.params.year]})}))}),e.userInGroup=function(e,r){return r&&r.users?!!r.users[e]:!1},e.addUserToGroup=function(e,r,t){return o.all([n.$inst("users",e,"groups").$set(t,r),n.$inst("groups",t,r,"users").$set(e,e)])},e.removeUserFromGroup=function(e,r,t){return o.all([n.$inst("users",e,"groups").$remove(t),n.$inst("groups",t,r,"users").$remove(e)])},e.invite=function(){FB.ui({method:"apprequests",title:"Coachella Friends",message:"Let's figure out which bands we all want to see this year."},function(r){r?r.error?console.error("Facebook Error: "+r.error):r.to&&(r.to.push(e.$me.facebook.id),angular.forEach(r.to,function(r){var o="facebook:"+r;e.addUserToGroup(o,e.group.$id,t.params.year)})):console.error("Facebook Error: Unknown")})}}]).controller("BandsCtrl",["$scope","$firebaseHelper",function(e,r){e.vote=function(t,o){var n=function(n){var a=r.$child(e.bands,t+"/votes/"+(n||e.$me.uid)+"/vote");a.$asObject().$loaded().then(function(e){e.$value==o?a.$remove():a.$set(o)})};e.$me.uid?n():e.$auth.$authWithOAuthPopup("facebook").then(function(e){n(e.uid)},function(e){console.error(e)})},e.filterDay=0,e.orderBy=void 0,e.orderByStr=void 0,e.orderByDir=!1,e.toggleOrder=function(r){if(r){var t={day:!1,name:!1,vote:!0,score:!0};if(e.orderByStr==r){if(e.orderByDir!==t[r])return e.toggleOrder();e.orderByDir=!e.orderByDir}else e.orderByDir=t[r]}switch(e.orderByStr=r,r){case"vote":r=function(r){var t=-2;return r.votes&&angular.forEach(r.votes,function(r,o){o==e.$me.uid&&(t=r.vote)}),t};break;case void 0:return e.orderBy=["day","$id"],e.orderByDir=!1,void 0;case"day":return e.orderBy=["day","name"],void 0}e.orderBy=r},e.toggleOrder()}]).controller("BandCtrl",["$scope",function(e){e.init=function(r){e.data=r},e.$watch("data.votes",function(r){var t=0;return angular.forEach(r,function(e){t+=e.vote}),e.data=e.data||{},e.data.score=t}),e.add=function(r){r&&r.name&&r.day&&e.bands.$add(r).then(function(){r.name="",e.added=!0})},e.remove=function(r,t){r&&r.$id&&(t||confirm("Are you sure you want to permanently delete this?"))&&e.bands.$remove(r)}}]).directive("ngAutofocus",function(){return{restrict:"A",link:function(e,r,t){e.$watch(function(){return e.$eval(t.ngAutofocus)},function(e){e&&r[0].focus()})}}});